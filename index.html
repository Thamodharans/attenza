<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#8b7cc8">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <title>ATTENZA - for Dispur College</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&display=swap" rel="stylesheet">

  <!-- flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    /* Basic reset & layout */
    :root{
      --bg:#fbfbff;
      --muted:#6b6f82;
      --accent:#8b7cc8;
      --card:#ffffff;
      --glass: rgba(50,53,68,0.04);
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:#23232b; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    /* avoid page freeze from hidden overflow */
    html, body { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    /* show small loading while auth check */
    body[aria-loading="true"]{
      opacity:0.98;
      pointer-events:auto;
    }
    /* header */
    .header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));backdrop-filter:blur(6px);box-shadow:0 2px 8px rgba(35,35,40,0.04);padding:10px 16px;display:flex;align-items:flex-start;flex-direction:column}
    .top-bar{display:flex;align-items:center;width:100%;gap:12px}
    .icon-btn{background:transparent;border:0;cursor:pointer;padding:8px;border-radius:8px}
    .menu-mini span{display:block;width:20px;height:2px;background:var(--muted);border-radius:2px;box-shadow:0 6px 0 var(--muted)}
    .brand-container{display:flex;flex-direction:column;line-height:1}
    .brand-name{font-weight:700;font-size:18px}
    .tagline{font-size:12px;color:var(--muted)}
    .notif-rev{margin-left:auto;position:relative}
    .notif-dot{position:absolute;right:8px;top:6px;width:9px;height:9px;background:#ef4444;border-radius:50%;box-shadow:0 0 0 3px rgba(239,68,68,0.06)}

    /* expand section */
    .expand-section{width:100%;overflow:hidden}
    .expand-arrow{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;padding:8px;border-radius:999px}
    .expanded-content{max-height:0;overflow:hidden;transition:max-height .28s ease}
    .expanded-content.open{max-height:420px}

    /* main content */
    .content-body{padding:18px 16px 40px}
    .welcome-section{display:flex;align-items:center;gap:18px}
    .attendance-ring{position:relative;width:140px;height:140px}
    .ring-svg{width:100%;height:100%}
    .ring-bg-circle{fill:none;stroke:#e9e9f2;stroke-width:12}
    .ring-progress-circle{fill:none;stroke:var(--accent);stroke-width:12;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;stroke-dasharray:440;stroke-dashoffset:110;transition:stroke-dashoffset .8s ease}
    .ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .percentage{font-weight:700;font-size:20px}
    .percentage-label{font-size:11px;color:var(--muted)}

    /* notebook */
    .notebook-section{padding:10px 16px}
    .page{background:linear-gradient(180deg,#fff,#fff);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(35,35,40,0.03);max-width:760px;margin:auto}

    /* install strip */
    .install-strip{position:fixed;left:16px;right:16px;bottom:16px;background:var(--card);border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 8px 28px rgba(35,35,40,0.06);z-index:60}
    .install-strip.hidden{display:none}

    /* sections, cards, grid */
    .section-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
    .carousel-container{padding:12px 16px}
    .carousel{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
    .class-card{min-width:260px;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(35,35,40,0.03);scroll-snap-align:center}
    .attendance-actions{display:flex;gap:8px;margin-top:10px}
    .attendance-btn{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(35,35,40,0.06);cursor:pointer;background:transparent}

    /* periodical grid */
    .periodical-section{padding:16px}
    .bento-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(35,35,40,0.03)}
    .span-2{grid-column:span 2}
    .span-full{grid-column:1/-1}

    /* subject card */
    .subject-card{display:flex;flex-direction:column;gap:8px}
    .subject-header{display:flex;align-items:center;justify-content:space-between}

    /* menu */
    .menu-view{position:fixed;inset:0;background:rgba(9,10,14,0.4);backdrop-filter:blur(4px);z-index:80;display:flex;justify-content:flex-end;pointer-events:none;opacity:0;transition:opacity .18s ease}
    .menu-view.open{pointer-events:auto;opacity:1}
    .app-view{width:360px;background:linear-gradient(180deg,#fff,#fbfbff);height:100%;overflow:auto;padding:16px;box-shadow:-12px 0 40px rgba(9,10,14,0.08)}
    .menu-profile-card{display:flex;gap:12px;align-items:center;padding:8px 0}
    .menu-profile-img{width:56px;height:56px;border-radius:10px;object-fit:cover}
    .menu-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer}
    .menu-item:hover{background:var(--glass)}
    .logout-section{margin-top:18px;display:flex;flex-direction:column;gap:10px}

    /* overlays & modals */
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:90;background:rgba(0,0,0,0.35);opacity:0;pointer-events:none;transition:opacity .16s ease}
    .modal-backdrop.open{opacity:1;pointer-events:auto}
    .modal{background:#fff;padding:18px;border-radius:10px;min-width:320px;max-width:90%}
    .hidden{display:none}

    /* results overlay */
    #result-overlay-container{position:fixed;left:0;right:0;top:0;bottom:0;z-index:75;display:none}
    #result-overlay-container.open{display:block}

    /* ai board & prompt */
    .ai-card-container{position:fixed;right:20px;bottom:20px;z-index:50}
    .prompt-area{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(35,35,40,0.06)}
    .prompt-input{border:0;outline:none;padding:6px;font-size:14px;width:180px;background:transparent}

    /* accessibility focus */
    button:focus, .menu-item:focus{outline:3px solid rgba(139,124,200,0.18);outline-offset:2px}

    /* responsive */
    @media (max-width:900px){
      .bento-grid{grid-template-columns:repeat(2,1fr)}
      .app-view{width:92%}
      .carousel{padding-left:8px}
      .attendance-ring{width:110px;height:110px}
    }
  </style>
</head>
<body aria-loading="true">
  <!-- HEADER -->
  <div class="header" id="header">
    <div class="top-bar">
      <button id="openMenuBtn" class="icon-btn" aria-label="Open menu" aria-controls="menuView" aria-expanded="false">
        <div class="menu-mini"><span></span></div>
      </button>

      <div class="brand-container">
        <span class="brand-name">ATTENZA</span>
        <span class="tagline">a student driven attendance tracker</span>
      </div>

      <button class="icon-btn notif-rev" aria-label="Notifications">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" aria-hidden="true">
          <path d="M12 5.365V3m0 2.365a5.338 5.338 0 0 1 5.133 5.368v1.8c0 2.386 1.867 2.982 1.867 4.175 0 .593 0 1.292-.538 1.292H5.538C5 18 5 17.301 5 16.708c0-1.193 1.867-1.789 1.867-4.175v-1.8A5.338 5.338 0 0 1 12 5.365ZM8.733 18c.094.852.306 1.54.944 2.112a3.48 3.48 0 0 0 4.646 0c.638-.572 1.236-1.26 1.33-2.112h-6.92Z" stroke="currentColor" stroke-width="2.25" stroke-linejoin="round" stroke-linecap="round"></path>
        </svg>
        <div class="notif-dot" aria-hidden="true"></div>
      </button>
    </div>

    <div class="expand-section">
      <div class="expand-arrow" id="expandArrow" role="button" aria-expanded="false" aria-controls="expandedContent">
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>

      <div class="expanded-content" id="expandedContent">
        <div class="content-inner" style="padding:12px 0">
          <div class="info-section">
            <h3 style="margin:0 0 6px 0">About ATTENZA</h3>
            <p style="margin:0;color:var(--muted)">A student-driven attendance tracker for Dispur College ‚Äî view your attendance data anytime, anywhere.</p>
          </div>

          <div class="info-section" style="margin-top:10px">
            <h3 style="margin:0 0 10px 0">Key Features</h3>
            <div class="features" style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="feature-card" style="min-width:160px;background:var(--card);padding:10px;border-radius:8px;box-shadow:0 6px 16px rgba(35,35,40,0.03)">
                <h4 style="margin:0 0 6px 0">üìä Real-time Data</h4>
                <p style="margin:0;color:var(--muted)">Check your attendance percentage instantly</p>
              </div>
              <div class="feature-card" style="min-width:160px;background:var(--card);padding:10px;border-radius:8px;box-shadow:0 6px 16px rgba(35,35,40,0.03)">
                <h4 style="margin:0 0 6px 0">üìÖ Subject-wise View</h4>
                <p style="margin:0;color:var(--muted)">Track attendance for each subject separately</p>
              </div>
              <div class="feature-card" style="min-width:160px;background:var(--card);padding:10px;border-radius:8px;box-shadow:0 6px 16px rgba(35,35,40,0.03)">
                <h4 style="margin:0 0 6px 0">üîî Smart Alerts</h4>
                <p style="margin:0;color:var(--muted)">Get notified when attendance falls below threshold</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="content-body" id="mainContent">
    <div class="welcome-section" aria-live="polite">
      <div class="welcome-text-content">
        <h3 id="welcomeTitle">Hello, User!</h3>
        <p id="welcomeSubtitle" style="color:var(--muted)">Great progress! Keep maintaining your attendance streak.</p>
      </div>

      <div class="attendance-ring" aria-hidden="true">
        <svg class="ring-svg" viewBox="0 0 160 160" role="img" aria-label="Attendance gauge">
          <circle class="ring-bg-circle" cx="80" cy="80" r="70"></circle>
          <circle class="ring-progress-circle" cx="80" cy="80" r="70" id="progressCircle"></circle>
        </svg>
        <div class="ring-center">
          <span class="percentage" id="percentageText">75%</span>
          <span class="percentage-label">Overall</span>
        </div>
      </div>
    </div>

    <div class="notebook-section">
      <div class="page">
        <img src="Image/your-logo.png" alt="Logo" class="note-logo" style="max-width:140px;margin-bottom:12px">
        <p style="color:var(--muted)">Keep a quick note of important classes, make-up days or attendance targets here.</p>
        <div style="display:flex;justify-content:flex-end;margin-top:18px">
          <span style="font-weight:600;color:var(--muted)">Principal</span>
        </div>
      </div>
    </div>

    <div class="install-strip" id="installStrip" role="region" aria-label="Install prompt">
      <div class="install-content" style="display:flex;align-items:center;gap:12px">
        <span class="install-text" id="installText">Install this site as an app</span>
      </div>
      <button class="close-strip" id="closeStrip" aria-label="Dismiss install prompt" style="background:transparent;border:0;cursor:pointer;padding:6px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <section class="periodical-section">
      <div class="section-header">
        <h3>Today's Schedule</h3>
        <a href="#" class="view-all" style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:6px">VIEW
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </a>
      </div>

      <div class="carousel-container">
        <div class="carousel" id="carousel" tabindex="0" aria-label="Class schedule carousel">
          <!-- Cards: keep content similar to original -->
          <div class="class-card" role="article">
            <div class="class-header">
              <span class="class-subject">Data Structures</span>
              <span class="class-time">09:00 AM</span>
            </div>
            <div class="class-details" style="margin-top:8px;color:var(--muted)">
              <div><strong>Room:</strong> CS-301</div>
              <div><strong>Faculty:</strong> Dr. Smith</div>
              <div><strong>Duration:</strong> 1 hour</div>
            </div>
            <div class="attendance-actions">
              <button class="attendance-btn btn-attend">Attend</button>
              <button class="attendance-btn btn-skip">Skip</button>
              <button class="attendance-btn btn-not-held">Not Held</button>
            </div>
          </div>

          <div class="class-card" role="article">
            <div class="class-header">
              <span class="class-subject">Database Systems</span>
              <span class="class-time">11:00 AM</span>
            </div>
            <div class="class-details" style="margin-top:8px;color:var(--muted)">
              <div><strong>Room:</strong> CS-205</div>
              <div><strong>Faculty:</strong> Prof. Johnson</div>
              <div><strong>Duration:</strong> 1.5 hours</div>
            </div>
            <div class="attendance-actions">
              <button class="attendance-btn btn-attend">Attend</button>
              <button class="attendance-btn btn-skip">Skip</button>
              <button class="attendance-btn btn-not-held">Not Held</button>
            </div>
          </div>

          <div class="class-card" role="article">
            <div class="class-header">
              <span class="class-subject">Web Development</span>
              <span class="class-time">02:00 PM</span>
            </div>
            <div class="class-details" style="margin-top:8px;color:var(--muted)">
              <div><strong>Room:</strong> Lab-102</div>
              <div><strong>Faculty:</strong> Ms. Williams</div>
              <div><strong>Duration:</strong> 2 hours</div>
            </div>
            <div class="attendance-actions">
              <button class="attendance-btn btn-attend">Attend</button>
              <button class="attendance-btn btn-skip">Skip</button>
              <button class="attendance-btn btn-not-held">Not Held</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="periodical-section" aria-labelledby="periodical-heading">
      <header class="periodical-header" id="periodical-heading">
        <h2 style="margin:0 0 8px 0">Periodical records</h2>
      </header>

      <div class="date-picker-container" style="display:flex;align-items:center;gap:12px">
        <div class="custom-flatpickr" style="display:flex;align-items:center;gap:8px">
          <input type="text" id="rangePicker" placeholder="Select date range..." data-input />
          <div class="date-display" id="dateDisplay" style="color:var(--muted)"><span id="startDate">Select date</span> <span style="margin:0 6px;color:var(--muted)">to</span> <span id="endDate">Select date</span></div>
        </div>
      </div>

      <div class="bento-grid" style="margin-top:12px">
        <!-- Overall card -->
        <article class="card metric-card span-2">
          <div class="card-title">Overall attendance</div>
          <div class="card-body" style="display:flex;align-items:center;gap:12px">
            <div class="circle-shell" style="width:90px;height:90px;position:relative">
              <svg viewBox="0 0 140 140" style="width:100%;height:100%">
                <circle class="circle-outer-ring" cx="70" cy="70" r="60" stroke="#eef0f8" stroke-width="12" fill="none"></circle>
                <circle id="overallCircle" cx="70" cy="70" r="60" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="377" stroke-dashoffset="94"></circle>
              </svg>
              <div class="circle-center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700">75%</div>
            </div>
            <div class="card-footer" style="color:var(--muted)">All subjects combined</div>
          </div>
        </article>

        <!-- Major card (interactive) -->
        <article class="card metric-card span-2" id="majorCard">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="card-title">Major subs overall</div>
            <button id="majorEdit" title="Select major subjects" class="icon-btn" aria-haspopup="dialog">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#323544" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
            </button>
          </div>

          <div class="card-body" style="display:flex;align-items:center;gap:12px">
            <div style="flex:1">
              <svg viewBox="0 0 140 80" style="width:100%;height:56px">
                <path d="M15 70 A55 55 0 0 1 125 70" stroke="#eef0f8" stroke-width="12" fill="none"/>
                <path id="majorHalfPath" d="M28 70 A40 40 0 0 1 112 70" stroke="var(--accent)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="125" stroke-dashoffset="125"></path>
              </svg>
              <div style="text-align:center;font-weight:700;margin-top:6px" id="majorPercent">0%</div>
            </div>
            <div class="card-footer" id="majorFooter" style="color:var(--muted)">Select major, click pencil button</div>
          </div>

          <div class="major-modal hidden" id="majorModal" aria-modal="true" role="dialog">
            <div class="major-modal-content">
              <div class="major-modal-subtitle">Select major subjects to calculate major overall.</div>
              <div class="major-modal-list" id="majorList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <label><input type="checkbox" value="Mathematics" class="major-checkbox" /> Mathematics</label>
                <label><input type="checkbox" value="Physics" class="major-checkbox" /> Physics</label>
                <label><input type="checkbox" value="Chemistry" class="major-checkbox" /> Chemistry</label>
                <label><input type="checkbox" value="Computer Science" class="major-checkbox" /> Computer Science</label>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button type="button" class="btn-ghost" id="majorCancel">Cancel</button>
                <button type="button" class="btn-primary" id="majorSave">Save</button>
              </div>
            </div>
          </div>
        </article>

        <article class="card info-card span-full">
          <div class="summary-header" style="display:flex;align-items:center;justify-content:space-between">
            <span class="summary-title">Attendance summary</span>
            <span class="summary-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#323544" stroke-width="1.8"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M7 9h10"></path><path d="M7 13h4"></path></svg>
            </span>
          </div>
          <div class="info-card-body" id="summaryBody" style="margin-top:8px;color:var(--muted)">
            <ul>
              <li id="summaryLine">Overall attendance is 75% for this period.</li>
              <li>Major subjects are not selected yet. Choose majors to track their combined attendance.</li>
            </ul>
          </div>
        </article>

        <!-- example subject cards -->
        <article class="card subject-card purple span-2">
          <div class="subject-header">
            <span class="subject-name">Mathematics</span>
            <span class="subject-icon" aria-hidden="true"></span>
          </div>
          <div class="subject-meta-group" style="color:var(--muted)">
            <div class="subject-meta">Total classes - 22</div>
            <div class="subject-meta">Attended - 18</div>
          </div>
          <div class="subject-percentage" style="font-weight:700">82%</div>
        </article>

        <article class="card subject-card span-2">
          <div class="subject-header"><span class="subject-name">Physics</span></div>
          <div class="subject-meta-group" style="color:var(--muted)"><div>Total classes - 20</div><div>Attended - 15</div></div>
          <div class="subject-percentage" style="font-weight:700">75%</div>
        </article>
      </div>
    </section>
  </main>

  <!-- MENU VIEW -->
  <section id="menuView" class="menu-view" aria-hidden="true">
    <div id="view-menu" class="app-view" role="dialog" aria-label="Main menu">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h1 style="margin:0;font-size:20px">Menu</h1>
        <button id="closeMenuBtn" class="nav-btn" aria-label="Close Menu">‚úï</button>
      </div>

      <div class="menu-profile-card">
        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=800&q=80" class="menu-profile-img" alt="Profile">
        <div style="flex:1">
          <h2 style="margin:0;font-size:16px">Johnathan Doe</h2>
          <p style="margin:6px 0;color:var(--muted)">john.doe23@university.edu</p>
          <div style="display:flex;gap:8px">
            <span style="background:var(--accent);color:#fff;padding:6px;border-radius:8px;font-size:12px">Roll - 234</span>
            <span style="background:#eee;padding:6px;border-radius:8px;font-size:12px">B.Com 1st Sem</span>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="menu-card" style="margin-bottom:20px;padding-bottom:12px">
          <div class="menu-item" onclick="window.location.href='setup.html'" role="button" tabindex="0" style="padding:12px;background:linear-gradient(180deg,#f8f6ff,#fff);border-radius:10px">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="background:var(--accent);color:white;padding:8px;border-radius:10px"><span style="font-size:14px">üìö</span></div>
              <div>
                <p style="margin:0;font-weight:600">Select Subjects</p>
                <p style="margin:0;color:var(--muted);font-size:13px">Set up subjects to track attendance</p>
              </div>
            </div>
            <span style="margin-left:auto;color:#d1d5db">‚Ä∫</span>
          </div>
        </div>

        <div class="menu-card">
          <a href="#" class="menu-item" style="display:flex;align-items:center;gap:10px">
            <span>üîñ</span>
            <span class="menu-item-text">Important Staff</span>
            <span style="margin-left:auto;color:#d1d5db">‚Ä∫</span>
          </a>
          <div style="height:10px"></div>
          <a href="#" class="menu-item" style="display:flex;align-items:center;gap:10px">
            <span>üë•</span>
            <span class="menu-item-text">Refer a Friend</span>
            <span style="margin-left:auto;color:#d1d5db">‚Ä∫</span>
          </a>
          <div style="height:10px"></div>
          <a href="#" class="menu-item" style="display:flex;align-items:center;gap:10px">
            <span>üí¨</span>
            <span class="menu-item-text">Report Issue</span>
            <span style="margin-left:auto;color:#d1d5db">‚Ä∫</span>
          </a>
          <div style="height:10px"></div>
          <a href="#" class="menu-item" style="display:flex;align-items:center;gap:10px">
            <span>‚öñÔ∏è</span>
            <span class="menu-item-text">Terms & Privacy</span>
            <span style="margin-left:auto;color:#d1d5db">‚Ä∫</span>
          </a>
        </div>

        <div class="logout-section">
          <button class="btn-logout" id="logoutBtn" style="background:#fff;border:1px solid rgba(35,35,40,0.06);padding:10px;border-radius:10px;cursor:pointer;display:flex;gap:8px;align-items:center">
            <span>‚éã</span> Log Out
          </button>
          <div class="version-text" style="color:var(--muted);font-size:12px">Attenza Educational ‚Ä¢ v1.0.4</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Result Overlay (search results) -->
  <div id="result-overlay-container">
    <div class="overlay-backdrop" onclick="exitSearchMode()" style="position:fixed;inset:0;z-index:70;"></div>
    <div class="result-wrapper" style="position:fixed;right:20px;top:80px;width:340px;background:white;border-radius:10px;padding:12px;box-shadow:0 12px 36px rgba(9,10,14,0.12);z-index:80">
      <div class="result-header" style="display:flex;justify-content:space-between;align-items:center">
        <span class="helper-text" style="color:var(--muted)">Showing students from</span>
        <div class="dropdown-wrapper" id="classDropdown" style="position:relative">
          <div class="class-pill" onclick="toggleDropdown()" style="cursor:pointer;padding:6px 8px;background:#f6f6fb;border-radius:8px;display:inline-flex;align-items:center;gap:8px">
            <span id="selectedClassText">B.Com Sem 5</span>
          </div>
          <div class="dropdown-list hidden" id="classDropdownList" style="position:absolute;right:0;top:40px;background:#fff;border-radius:8px;padding:8px;box-shadow:0 12px 36px rgba(9,10,14,0.08)"></div>
        </div>
      </div>

      <div class="result-card" id="foundState" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:46px;height:46px;border-radius:10px;background:#f2f4f8;display:flex;align-items:center;justify-content:center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </div>
          <div>
            <div class="student-name" style="font-weight:600">Rahul Sharma</div>
            <div class="data-freshness" style="color:var(--muted);font-size:13px">Updated 2h ago</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="percentage-val" style="font-weight:700">78%</div>
          <div style="color:var(--muted);font-size:12px">Overall</div>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modal" role="document">
      <h3 id="editModalTitle">Edit record</h3>
      <div class="modal-subject" id="modalSubject"></div>

      <div class="form-group">
        <label for="modalStatus">Status</label>
        <select id="modalStatus">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="not-held">Class not held</option>
        </select>
      </div>

      <div class="form-group">
        <label for="modalRemarks">Remarks / Notes</label>
        <textarea id="modalRemarks" placeholder="Add your notes for this class" style="width:100%;min-height:84px"></textarea>
      </div>

      <div class="modal-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
        <button class="btn btn-primary" id="modalSave">Save changes</button>
      </div>
    </div>
  </div>

  <!-- AI BOARD (minimal) -->
  <div class="ai-board-overlay hidden" id="aiBoardOverlay" aria-hidden="true">
    <div class="ai-board">
      <div class="ai-board-header" style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="ai-title">Attenza AI</h2>
        <button class="ai-close-btn" id="aiCloseBtn" aria-label="Close AI">√ó</button>
      </div>
      <div class="ai-board-body">
        <div class="ai-response" id="aiResponse" style="color:var(--muted)">Once you connect Gemini and your attendance backend, this will show real insights.</div>
      </div>
    </div>
  </div>

  <!-- AI prompt -->
  <div class="ai-card-container" aria-hidden="false">
    <div class="prompt-area" id="promptArea">
      <div class="prompt-display" style="display:flex;align-items:center;gap:8px">
        <span class="typewriter-text" id="typewriterText" aria-hidden="true"></span>
        <input type="text" id="promptInput" class="prompt-input" placeholder="Ask Attenza AI..." aria-label="Ask Attenza AI">
      </div>
      <button class="send-btn" id="sendBtn" aria-label="Send prompt" title="Send">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px"><path d="M12 5L18 11" stroke="white" stroke-width="2.4" stroke-linecap="round"/><path d="M12 5L6 11" stroke="white" stroke-width="2.4" stroke-linecap="round"/><path d="M12 5V19" stroke="white" stroke-width="2.4" stroke-linecap="round"/></svg>
      </button>
    </div>
  </div>

  <!-- flatpickr and Firebase (module) + main logic -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script type="module">
    // ---------- FIREBASE (keep your config) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbFEWKJylJJgNw0KIyFsDxlDKPwJII73o",
      authDomain: "attenza-app.firebaseapp.com",
      projectId: "attenza-app",
      storageBucket: "attenza-app.firebasestorage.app",
      messagingSenderId: "435010148378",
      appId: "1:435010148378:web:e5540806fd0ef90b16d9a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Show body only after auth check or fallback
    const body = document.body;
    let authResolved = false;

    function revealBody() {
      body.style.visibility = "visible";
      body.removeAttribute('aria-loading');
      authResolved = true;
    }

    // Safety fallback: If auth stalled (network), reveal UI after 6s so user can debug.
    const fallbackTimer = setTimeout(() => {
      if (!authResolved) {
        console.warn("Auth check timed out ‚Äî showing UI (fallback).");
        revealBody();
      }
    }, 6000);

    onAuthStateChanged(auth, async (user) => {
      clearTimeout(fallbackTimer);
      if (!user) {
        // Not logged in -> redirect
        try { window.location.replace("login.html"); }
        catch(e){ console.warn("Redirect failed:", e); revealBody(); }
        return;
      }

      // Check user profile doc
      try {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists() && userSnap.data().profileComplete === true) {
          revealBody();
        } else {
          // incomplete profile -> redirect to login/registration
          window.location.replace("login.html");
        }
      } catch (err) {
        console.error("Auth Check Error:", err);
        // fallback to prevent frozen UI
        revealBody();
      }
    });
  </script>

  <script>
    // ---------- UI behavior & fixes ----------
    (function () {
      // Make sure body is hidden initially to avoid flashing; if auth fallback shows it will be revealed
      document.body.style.visibility = document.body.style.visibility || 'hidden';

      // Menu open/close
      const openMenuBtn = document.getElementById('openMenuBtn');
      const closeMenuBtn = document.getElementById('closeMenuBtn');
      const menuView = document.getElementById('menuView');

      function openMenu() {
        menuView.classList.add('open');
        menuView.setAttribute('aria-hidden', 'false');
        openMenuBtn.setAttribute('aria-expanded', 'true');
      }
      function closeMenu() {
        menuView.classList.remove('open');
        menuView.setAttribute('aria-hidden', 'true');
        openMenuBtn.setAttribute('aria-expanded', 'false');
      }
      openMenuBtn.addEventListener('click', openMenu);
      closeMenuBtn.addEventListener('click', closeMenu);

      // allow Esc to close menu / modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (menuView.classList.contains('open')) closeMenu();
          const editModal = document.getElementById('editModal');
          if (editModal && editModal.classList.contains('open')) toggleEditModal(false);
        }
      });

      // Expand section toggle
      const expandArrow = document.getElementById('expandArrow');
      const expandedContent = document.getElementById('expandedContent');
      expandArrow.addEventListener('click', () => {
        const open = expandedContent.classList.toggle('open');
        expandArrow.setAttribute('aria-expanded', open ? 'true' : 'false');
      });

      // Install strip close
      const closeStrip = document.getElementById('closeStrip');
      const installStrip = document.getElementById('installStrip');
      closeStrip.addEventListener('click', () => installStrip.classList.add('hidden'));

      // Carousel: allow wheel to scroll horizontally for better UX
      const carousel = document.getElementById('carousel');
      if (carousel) {
        carousel.addEventListener('wheel', (e) => {
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            e.preventDefault();
            carousel.scrollLeft += e.deltaY;
          }
        }, { passive: false });
      }

      // Major modal open/close & save simulation
      const majorEdit = document.getElementById('majorEdit');
      const majorModal = document.getElementById('majorModal');
      const majorCancel = document.getElementById('majorCancel');
      const majorSave = document.getElementById('majorSave');
      const majorPercent = document.getElementById('majorPercent');
      const majorHalfPath = document.getElementById('majorHalfPath');

      function toggleMajorModal(show) {
        if (!majorModal) return;
        majorModal.classList.toggle('hidden', !show);
        if (show) majorModal.querySelector('input[type="checkbox"]').focus();
      }
      majorEdit && majorEdit.addEventListener('click', () => toggleMajorModal(true));
      majorCancel && majorCancel.addEventListener('click', () => toggleMajorModal(false));
      majorSave && majorSave.addEventListener('click', () => {
        // For demo: count checked and compute a fake percent
        const checks = Array.from(document.querySelectorAll('.major-checkbox')).filter(c => c.checked).length;
        const percent = Math.min(100, checks * 25);
        majorPercent.textContent = percent + '%';
        // update path stroke offset to reflect percentage visually
        const dash = 125; // value matching CSS drawing
        majorHalfPath.style.transition = 'stroke-dashoffset .6s ease';
        majorHalfPath.style.strokeDashoffset = dash - (dash * percent / 100);
        document.getElementById('majorFooter').textContent = checks ? `${checks} majors selected` : 'No majors selected';
        toggleMajorModal(false);
      });

      // Result overlay controls (search)
      window.toggleDropdown = function () {
        const list = document.getElementById('classDropdownList');
        if (!list) return;
        if (list.classList.contains('hidden')) {
          // populate items quickly
          list.innerHTML = ['B.Com Sem 5','B.Com Sem 3','B.A. Sem 1','H.S. 2nd Year'].map(v => `<div class="dropdown-item" style="padding:6px 8px;cursor:pointer" onclick="selectClass('${v}')">${v}</div>`).join('');
          list.classList.remove('hidden');
        } else list.classList.add('hidden');
      };
      window.selectClass = function (name) {
        document.getElementById('selectedClassText').textContent = name;
        const list = document.getElementById('classDropdownList');
        list && list.classList.add('hidden');
      };
      window.exitSearchMode = function () {
        document.getElementById('result-overlay-container').classList.remove('open');
      };

      // Edit modal show/hide helper
      const editModal = document.getElementById('editModal');
      function toggleEditModal(show) {
        if (!editModal) return;
        editModal.classList.toggle('open', show);
        editModal.classList.toggle('hidden', !show);
      }
      document.getElementById('modalCancel').addEventListener('click', () => toggleEditModal(false));
      // modalSave would persist to DB in your real app

      // Typewriter demo for prompt (non-blocking)
      const typewriterText = document.getElementById('typewriterText');
      const phrases = ['Ask about attendance', 'Find low-attendance subjects', 'How to improve attendance?'];
      let pi = 0;
      (function typeP() {
        let p = phrases[pi % phrases.length], idx=0;
        typewriterText.textContent = '';
        const t = setInterval(() => {
          typewriterText.textContent += p[idx++] || '';
          if (idx > p.length) {
            clearInterval(t);
            setTimeout(() => { typeP(); }, 1400);
          }
        }, 38);
        pi++;
      })();

      // Flatpickr init (range)
      try {
        flatpickr("#rangePicker", {
          mode: "range",
          dateFormat: "d M, Y",
          onClose: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
              const [start, end] = selectedDates;
              document.getElementById('startDate').textContent = instance.formatDate(start, 'd M, Y');
              document.getElementById('endDate').textContent = instance.formatDate(end, 'd M, Y');
              document.getElementById('summaryLine').textContent = `Overall attendance is 75% for ${instance.formatDate(start,'d M')} ‚Äî ${instance.formatDate(end,'d M')}.`;
            } else {
              document.getElementById('startDate').textContent = 'Select date';
              document.getElementById('endDate').textContent = 'Select date';
            }
          }
        });
      } catch(e){ console.warn('flatpickr failed to initialize', e); }

      // small animation for ring according to percentage text
      function animateRings() {
        const percentText = document.getElementById('percentageText').textContent.replace('%','') || 75;
        const p = Math.max(0, Math.min(100, Number(percentText)));
        const circle = document.getElementById('progressCircle');
        const circumference = 2 * Math.PI * 70;
        const offset = circumference * (1 - p/100);
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = offset;
        // overall small circle too
        const overall = document.getElementById('overallCircle');
        if (overall) {
          const circ2 = 2 * Math.PI * 60;
          const off2 = circ2 * (1 - p/100);
          overall.style.strokeDasharray = circ2;
          overall.style.strokeDashoffset = off2;
        }
      }
      // kickoff
      setTimeout(animateRings, 300);

      // Accessibility: trap focus inside menu when open (light)
      menuView.addEventListener('keydown', function(e){
        if (e.key !== 'Tab' || !menuView.classList.contains('open')) return;
        // not a full trap ‚Äî just close on shift-tab from first or tab from last
        const focusable = menuView.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0], last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      });

      // Prevent visual freeze if body still hidden for any reason (defensive)
      setTimeout(() => {
        if (document.body.style.visibility === 'hidden') {
          document.body.style.visibility = 'visible';
          document.body.removeAttribute('aria-loading');
        }
      }, 9000);
    })();
  </script>

</body>
</html>
